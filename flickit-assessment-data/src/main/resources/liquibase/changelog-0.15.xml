<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.17.xsd">

    <changeSet id="0.15-1" author="MKouhestani">
        <addColumn tableName="fak_subject">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-2" author="MKouhestani">
        <addColumn tableName="fak_attribute">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-3" author="MKouhestani">
        <addColumn tableName="fak_questionnaire">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-4" author="MKouhestani">
        <addColumn tableName="fak_question">
            <column name="kit_id" type="bigint"
                    valueComputed="fak_questionnaire.kit_id FROM fak_questionnaire WHERE questionnaire_id = fak_questionnaire.id">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-5" author="MKouhestani">
        <addColumn tableName="fak_question_impact">
            <column name="kit_id" type="bigint"
                    valueComputed="fak_question.kit_id FROM fak_question WHERE question_id = fak_question.id">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-6" author="MKouhestani">
        <addColumn tableName="fak_answer_option">
            <column name="kit_id" type="bigint"
                    valueComputed="fak_question.kit_id FROM fak_question WHERE question_id = fak_question.id">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-7" author="MKouhestani">
        <addColumn tableName="fak_answer_option_impact">
            <column name="kit_id" type="bigint"
                    valueComputed="fak_question_impact.kit_id FROM fak_question_impact WHERE question_impact_id = fak_question_impact.id">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-8" author="MKouhestani">
        <addColumn tableName="fak_question">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-9" author="MKouhestani">
        <addColumn tableName="fak_question_impact">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-10" author="MKouhestani">
        <addColumn tableName="fak_answer_option">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-11" author="MKouhestani">
        <addColumn tableName="fak_answer_option_impact">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-12" author="MKouhestani">
        <addColumn tableName="fak_maturity_level">
            <column name="reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-13" author="MKouhestani">
        <addColumn tableName="fac_answer">
            <column name="question_reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-14" author="MKouhestani">
        <update tableName="fac_answer">
            <column name="question_reference_number"
                    valueComputed="fak_question.reference_number FROM fak_question WHERE fak_question.id = question_id"/>
        </update>
    </changeSet>

    <changeSet id="0.15-15" author="MKouhestani">
        <addColumn tableName="fac_subject_value">
            <column name="subject_reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-16" author="MKouhestani">
        <update tableName="fac_subject_value">
            <column name="subject_reference_number"
                    valueComputed="fak_subject.reference_number FROM fak_subject WHERE fak_subject.id = subject_id"/>
        </update>
    </changeSet>

    <changeSet id="0.15-17" author="MKouhestani">
        <addColumn tableName="fac_quality_attribute_value">
            <column name="attribute_reference_number" type="uuid" defaultValueComputed="gen_random_uuid()">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-18" author="MKouhestani">
        <update tableName="fac_quality_attribute_value">
            <column name="attribute_reference_number"
                    valueComputed="fak_attribute.reference_number FROM fak_attribute WHERE fak_attribute.id = quality_attribute_id"/>
        </update>
    </changeSet>

    <changeSet id="0.15-19" author="MKouhestani">
        <sql>CREATE TABLE new_assessment_kit AS (SELECT * FROM fak_assessment_kit);</sql>
    </changeSet>

    <changeSet id="0.15-20" author="MKouhestani">
        <renameTable oldTableName="fak_assessment_kit" newTableName="fak_assessment_kit_version"/>
    </changeSet>

    <changeSet id="0.15-21" author="MKouhestani">
        <renameTable oldTableName="new_assessment_kit" newTableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.15-22" author="MKouhestani">
        <createSequence sequenceName="fak_assessment_kit_version_id_seq"
                        dataType="bigint"
                        startValue="1"/>
    </changeSet>

    <changeSet id="0.15-23" author="MKouhestani">
        <sql>SELECT setval('fak_assessment_kit_version_id_seq', nextVal('fak_assessment_kit_id_seq'))</sql>
    </changeSet>

    <changeSet id="0.15-24" author="MKouhestani">
        <addColumn tableName="fak_assessment_kit_version">
            <column name="version_status" type="tinyint" valueNumeric="1">
                <constraints nullable="false"/>
            </column>
            <column name="kit_id" type="bigint" valueComputed="id">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-25" author="MKouhestani">
        <dropColumn tableName="fak_assessment_kit_version">
            <column name="code"/>
            <column name="title"/>
            <column name="summary"/>
            <column name="about"/>
            <column name="published"/>
            <column name="is_private"/>
            <column name="expert_group_id"/>
            <column name="creation_time"/>
            <column name="last_modification_time"/>
            <column name="created_by"/>
            <column name="last_modified_by"/>
            <column name="last_major_modification_time"/>
        </dropColumn>
    </changeSet>

    <changeSet id="0.15-26" author="MKouhestani">
        <addColumn tableName="fak_assessment_kit">
            <column name="kit_version_id" type="bigint" valueComputed="id">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

    <changeSet id="0.15-27" author="MKouhestani">
        <renameColumn tableName="fak_subject" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-28" author="MKouhestani">
        <renameColumn tableName="fak_attribute" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-29" author="MKouhestani">
        <renameColumn tableName="fak_questionnaire" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-30" author="MKouhestani">
        <renameColumn tableName="fak_question" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-31" author="MKouhestani">
        <renameColumn tableName="fak_question_impact" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-32" author="MKouhestani">
        <renameColumn tableName="fak_answer_option" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-33" author="MKouhestani">
        <renameColumn tableName="fak_answer_option_impact" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-34" author="MKouhestani">
        <renameColumn tableName="fak_maturity_level" oldColumnName="kit_id" newColumnName="kit_version_id"/>
    </changeSet>

    <changeSet id="0.15-35" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fak_assessment_kit"
                                 baseColumnNames="expert_group_id"
                                 referencedTableName="baseinfo_expertgroup"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_assessmentkit_expertgroup"/>
    </changeSet>

    <changeSet id="0.15-36" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fak_assessment_kit"
                                 baseColumnNames="created_by"
                                 referencedTableName="account_user"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_assessmentkit_user_createdby"/>
    </changeSet>

    <changeSet id="0.15-37" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fak_assessment_kit"
                                 baseColumnNames="last_modified_by"
                                 referencedTableName="account_user"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_assessmentkit_user_lastmodifiedby"/>
    </changeSet>

    <changeSet id="0.15-38" author="MKouhestani">
        <addUniqueConstraint tableName="fak_assessment_kit" columnNames="code" constraintName="uq_fak_assessmentkit_code"/>
    </changeSet>

    <changeSet id="0.15-39" author="MKouhestani">
        <addUniqueConstraint tableName="fak_assessment_kit" columnNames="title" constraintName="uq_fak_assessmentkit_title"/>
    </changeSet>

    <changeSet id="0.15-40" author="MKouhestani">
        <sql>ALTER INDEX pk_fak_assessment_kit RENAME TO pk_fak_assessment_kit_version</sql>
    </changeSet>

    <changeSet id="0.15-41" author="MKouhestani">
        <addPrimaryKey tableName="fak_assessment_kit" columnNames="id" constraintName="pk_fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.15-42" author="MKouhestani">
        <dropUniqueConstraint tableName="fak_kit_dsl" constraintName="fk_fak_kitdsl_assessmentkit"/>
    </changeSet>

    <changeSet id="0.15-43" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fak_kit_dsl" baseColumnNames="assessment_kit_id"
                                 referencedTableName="fak_assessment_kit"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_kitdsl_assessmentkit"
                                 deferrable="true" initiallyDeferred="true"/>
    </changeSet>

    <changeSet id="0.15-44" author="MKouhestani">
        <dropUniqueConstraint tableName="baseinfo_assessmentkittag_assessmentkits" constraintName="baseinfo_profiletag__assessmentkit_id_511ef243_fk_baseinfo_"/>
    </changeSet>

    <changeSet id="0.15-45" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="baseinfo_assessmentkittag_assessmentkits" baseColumnNames="assessmentkit_id"
                                 referencedTableName="fak_assessment_kit"
                                 referencedColumnNames="id"
                                 constraintName="baseinfo_profiletag__assessmentkit_id_511ef243_fk_baseinfo_"
                                 deferrable="true" initiallyDeferred="true"/>
    </changeSet>

    <changeSet id="0.15-46" author="MKouhestani">
        <dropUniqueConstraint tableName="fak_kit_user_access" constraintName="fk_fak_kit_user_access_assessmentkit"/>
    </changeSet>

    <changeSet id="0.15-47" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fak_kit_user_access"
                                 baseColumnNames="kit_id"
                                 referencedTableName="fak_assessment_kit"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_kit_user_access_assessmentkit"
                                 deferrable="true" initiallyDeferred="true" onDelete="CASCADE"
                                 validate="true"/>
    </changeSet>

</databaseChangeLog>
