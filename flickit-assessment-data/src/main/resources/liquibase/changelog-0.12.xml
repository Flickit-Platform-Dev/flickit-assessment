<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.17.xsd">

    <changeSet id="0.12-01" author="MKouhestani">
        <addColumn tableName="fac_evidence">
            <column name="last_modified_by" type="uuid"/>
        </addColumn>
    </changeSet>

    <changeSet id="0.12-02" author="MKouhestani">
        <update tableName="fac_evidence">
            <column name="created_by_id" valueComputed="fac_assessment.created_by FROM fac_assessment WHERE
            fac_assessment.id = assessment_id"/>
        </update>
    </changeSet>

    <changeSet id="0.12-03" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fac_evidence"
                                 baseColumnNames="created_by_id"
                                 referencedTableName="account_user"
                                 referencedColumnNames="id"
                                 constraintName="fk_fac_evidence_user_createdby"/>
    </changeSet>

    <changeSet id="0.12-04" author="MKouhestani">
        <addForeignKeyConstraint baseTableName="fac_evidence"
                                 baseColumnNames="last_modified_by"
                                 referencedTableName="account_user"
                                 referencedColumnNames="id"
                                 constraintName="fk_fac_evidence_user_lastmodifiedby"/>
    </changeSet>

    <changeSet id="0.12-05" author="MKouhestani">
        <update tableName="fac_evidence">
            <column name="last_modified_by" valueComputed="fac_assessment.created_by FROM fac_assessment WHERE
            fac_assessment.id = assessment_id"/>
        </update>
    </changeSet>

    <changeSet id="0.12-06" author="MKouhestani">
        <addNotNullConstraint columnName="last_modified_by"
                              constraintName="last_modified_by_not_null"
                              tableName="fac_evidence"/>
    </changeSet>

    <changeSet id="0.12-07" author="Ali Sedaghat">
        <renameTable oldTableName="baseinfo_assessmentkit" newTableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.12-08" author="Ali Sedaghat">
        <renameColumn tableName="fak_assessment_kit" oldColumnName="is_active" newColumnName="published"/>
    </changeSet>

    <changeSet id="0.12-09" author="Ali Sedaghat">
        <sql>alter table fak_assessment_kit rename constraint baseinfo_assessmentprofile_pkey to pk_fak_assessment_kit;</sql>
    </changeSet>

    <changeSet id="0.12-10" author="Ali Sedaghat">
        <dropAllForeignKeyConstraints baseTableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.12-11" author="Ali Sedaghat">
        <dropUniqueConstraint constraintName="baseinfo_assessmentprofile_code_5a9ff625_uniq" tableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.12-12" author="Ali Sedaghat">
        <dropUniqueConstraint constraintName="baseinfo_assessmentprofile_title_0279319f_uniq" tableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.12-13" author="Ali Sedaghat">
        <addForeignKeyConstraint baseTableName="fak_assessment_kit"
                                 baseColumnNames="expert_group_id"
                                 referencedTableName="baseinfo_expertgroup"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_assessmentkit_expertgroup"/>
    </changeSet>

    <changeSet id="0.12-14" author="Ali Sedaghat">
        <addUniqueConstraint tableName="fak_assessment_kit" columnNames="code" constraintName="uq_fak_assessmentkit_code"/>
    </changeSet>

    <changeSet id="0.12-15" author="Ali Sedaghat">
        <addUniqueConstraint tableName="fak_assessment_kit" columnNames="title" constraintName="uq_fak_assessmentkit_title"/>
    </changeSet>

    <changeSet id="0.12-16" author="Ali Sedaghat">
        <renameSequence oldSequenceName="baseinfo_assessmentprofile_id_seq" newSequenceName="fak_assessment_kit_id_seq"/>
    </changeSet>

    <changeSet id="0.12-17" author="Ali Sedaghat">
        <addColumn tableName="fak_assessment_kit">
            <column name="created_by" type="uuid"/>
            <column name="last_modified_by" type="uuid"/>
        </addColumn>
    </changeSet>

    <changeSet id="0.12-18" author="Ali Sedaghat">
        <addForeignKeyConstraint baseTableName="fak_assessment_kit"
                                 baseColumnNames="created_by"
                                 referencedTableName="account_user"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_assessmentkit_user_createdby"/>
    </changeSet>

    <changeSet id="0.12-19" author="Ali Sedaghat">
        <addForeignKeyConstraint baseTableName="fak_assessment_kit"
                                 baseColumnNames="last_modified_by"
                                 referencedTableName="account_user"
                                 referencedColumnNames="id"
                                 constraintName="fk_fak_assessmentkit_user_lastmodifiedby"/>
    </changeSet>

    <changeSet id="0.12-20" author="Ali Sedaghat">
        <update tableName="fak_assessment_kit">
            <column name="created_by"
                    valueComputed="baseinfo_expertgroup.owner_id FROM baseinfo_expertgroup
                     WHERE fak_assessment_kit.expert_group_id = baseinfo_expertgroup.id"/>
        </update>
    </changeSet>

    <changeSet id="0.12-21" author="Ali Sedaghat">
        <update tableName="fak_assessment_kit">
            <column name="last_modified_by"
                    valueComputed="baseinfo_expertgroup.owner_id FROM baseinfo_expertgroup
                     WHERE fak_assessment_kit.expert_group_id = baseinfo_expertgroup.id"/>
        </update>
    </changeSet>

    <changeSet id="0.12-22" author="Ali Sedaghat">
        <addNotNullConstraint columnName="created_by" tableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.12-23" author="Ali Sedaghat">
        <addNotNullConstraint columnName="last_modified_by" tableName="fak_assessment_kit"/>
    </changeSet>

    <changeSet id="0.12-24" author="Ali Sedaghat">
        <renameColumn tableName="fac_evidence" oldColumnName="created_by_id" newColumnName="created_by"/>
    </changeSet>

    <changeSet id="0.12-25" author="MKouhestani">
        <addColumn tableName="baseinfo_assessmentkitdsl">
            <column name="creation_time" type="timestamp" defaultValueComputed="current_timestamp">
                <constraints nullable="false"/>
            </column>
        </addColumn>
    </changeSet>

</databaseChangeLog>
