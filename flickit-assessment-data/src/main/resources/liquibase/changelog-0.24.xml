<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                                       http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.17.xsd">

    <changeSet id="0.24.01" author="Maziyar Gerami">
        <sql>
            WITH DuplicateTitles AS (
                SELECT
                    ctid,
                    title,
                    created_by,
                    ROW_NUMBER() OVER (PARTITION BY title, created_by ORDER BY ctid) AS row_num
                FROM
                    fau_space
            )
            UPDATE fau_space
            SET title = CONCAT(title, '_', id)
            WHERE ctid IN (
                SELECT ctid
                FROM DuplicateTitles
                WHERE row_num > 1
            );
        </sql>
        <addUniqueConstraint tableName="fau_space" columnNames="title, created_by" constraintName="uq_fau_space_code_createdby"/>
    </changeSet>

    <changeSet id="0.24.02" author="Maziyar Gerami">
        <dropUniqueConstraint tableName="fau_space" constraintName="uq_fau_space_code"/>
    </changeSet>

    <changeSet id="0.24.03" author="Maziyar Gerami">
        <update tableName="fau_space">
            <column name="code" valueComputed="LOWER(REGEXP_REPLACE(CONCAT(title ,'-',id), '[\s]', '-', 'g'))"/>
        </update>
    </changeSet>
</databaseChangeLog>
